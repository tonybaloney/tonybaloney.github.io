<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Modifying the Python language in 6 minutes</title>

    <script>
    (function() {
        // Set initial theme as early as possible to avoid flash. Use stored preference if present,
        // otherwise default to the user's system preference (prefers-color-scheme).
        var stored = null;
        try { stored = localStorage.getItem('theme'); } catch (e) { stored = null; }
        var theme;
        if (stored === 'light' || stored === 'dark') {
            theme = stored;
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            theme = 'dark';
        } else {
            theme = 'light';
        }
        document.documentElement.setAttribute('data-theme', theme);
    })();
    </script>

    <!-- Facebook Meta tags -->
    <meta property="og:title" content="Modifying the Python language in 6 minutes">
    <meta property="og:description" content="Showing you how to hack the Python grammar and compiler">
    <meta property="og:image" content="https://tonybaloney.github.io/img/posts/token-s2.png">
    <meta property="og:url" content="https://tonybaloney.github.io/posts/modifying-the-python-language-in-6-minutes.html">
    <!-- Twitter Meta Tags -->
    <meta name="twitter:title" content="Modifying the Python language in 6 minutes">
    <meta name="twitter:description" content="Showing you how to hack the Python grammar and compiler">
    <meta name="twitter:image" content="https://tonybaloney.github.io/img/posts/token-s2.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@anthonypjshaw">

    <!-- Bootstrap Core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Blog Post CSS -->
    <link href="/css/homepage.css" rel="stylesheet">
    <link href="/css/blog-post.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&family=Lora:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/a11y-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>

    <script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/x86asm.min.js"></script>
    <script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-inner">
                <a href="/" class="navbar-brand"><span class="navbar-brand-symbol">&gt;</span><span class="navbar-brand-text"> tonybaloney</span></a>
                <ul class="navbar-links">
                    <li><a href="/#book">Book</a></li>
                    <li><a href="/#projects">Projects</a></li>
                    <li><a href="/#blog">Blog</a></li>
                    <li><a href="/#podcasts">Podcasts</a></li>
                    <li><a href="https://github.com/tonybaloney" class="icon-link"><i class="fa fa-github"></i></a></li>
                    <li><a href="https://www.youtube.com/c/AnthonyShaw" class="icon-link"><i class="fa fa-youtube-play"></i></a></li>
                    <li><a href="/rss.xml" class="icon-link"><i class="fa fa-rss"></i></a></li>
                    <li><button id="theme-toggle" aria-label="Toggle dark mode"><i class="fa fa-moon-o"></i></button></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="intro-header" style="background-image: url('/img/posts/token-s2.png')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="site-heading">
                        <h1>Modifying the Python language in 6 minutes</h1>
                        <hr class="small">
                        <span class="subheading">by Anthony Shaw, April 17, 2017</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="content-container">
        <p>This week I raised <a href="https://github.com/python/cpython/pull/1069">my first pull-request</a> to the CPython core project, which was declined :-( but as to not completely waste my time I’m writing my findings on how CPython works and show you how easy it is to modify the Python syntax.
I’m going to show you how to add a new feature to the Python syntax. That syntax is the increment/decrement operator, a common operator in most languages. Just to prove, open up the REPL and try it.</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/bad-syntax.png"></p>
<h2 id="level-1-peps">Level 1: PEPs<a class="headerlink" href="#level-1-peps" title="Permanent link">&para;</a></h2>
<p>Before the Python syntax is changed, a proposal needs to be made with a set of reasons, design and behaviours. All language changes are discussed by the core Python team and approved by the BDFL. Increment operators are not approved (and probably never will be), which gives us a good test.</p>
<h2 id="level-2-grammar">Level 2: Grammar<a class="headerlink" href="#level-2-grammar" title="Permanent link">&para;</a></h2>
<p>The Grammar file is simple text file describing all the elements of the Python language. This is used by not just CPython, but other implementations like PyPy to keep consistency and agree on the types of language semantics.
Internally, these keys form the tokens, which are parsed by the lexer. When you <code>make -j</code> a command converts these into a set of enums and constants in the C headers. This allows us to reference them later on.</p>
<pre><code class="default">stmt: simple_stmt | compound_stmt
simple_stmt: small_stmt (';' small_stmt)* [';'] NEWLINE
# ...
pass_stmt: 'pass'
flow_stmt: break_stmt | continue_stmt | return_stmt | raise_stmt | yield_stmt
break_stmt: 'break'
continue_stmt: 'continue'
# ..
import_as_name: NAME ['as' NAME]
</code></pre>

<p>So, a <code>simple_stmt</code> is a simple statement, it can optionally have a semicolon, like when you put <code>import pdb; pdb.set_trace()</code> and ends in a new line <code>NEWLINE</code>. A <code>pass_stmt</code> is the word pass, a <code>break_stmt</code> is the work break. Simple, right?
Let’s add an increment and decrement expression, something which does not exist in the language. It would be another option in an expression statement, along with yields, augmented assignment and regular assignment, i.e.foo=1.</p>
<pre><code class="default"># Add increment and decrement to expression statement
expr_stmt: testlist_star_expr (annassign | augassign (yield_expr|testlist) |
                     ('=' (yield_expr|testlist_star_expr))* | incr_stmt | decr_stmt)
annassign: ':' test ['=' test]
testlist_star_expr: (test|star_expr) (',' (test|star_expr))* [',']
augassign: ('+=' | '-=' | '*=' | '@=' | '/=' | '%=' | '&amp;=' | '|=' | '^=' |
            '&lt;&lt;=' | '&gt;&gt;=' | '**=' | '//=')
# For normal and annotated assignments, additional restrictions enforced by the interpreter
del_stmt: 'del' exprlist

# New statements
incr_stmt: '++'
decr_stmt: '--'
</code></pre>

<p>We add it to the possible list of small statements (this will become obvious in the AST). The <code>incr_stmt</code> will be our increment method and <code>decr_stmt</code> will be a decrement. Both follow a <code>NAME</code> (a variable name) and form a small standalone statement. When we build the Python project it will generate the components for us (not yet).
If you start Python with -d and try it you should get:</p>
<p>Token <ERRORTOKEN>/’++’ … Illegal token</p>
<p>What is a token? Let’s find out..</p>
<h2 id="level-3-lexer">Level 3 : Lexer<a class="headerlink" href="#level-3-lexer" title="Permanent link">&para;</a></h2>
<p>There are four steps that Python takes when you hit return: lexing, parsing, compiling, and interpreting. Lexing is breaking the line of code you just typed into tokens. The CPython lexer is called tokenizer.c. It has the functions that read from a file (like python file.py, a string (like the REPL). It also handles the special encoding comment at the top of files and parses your file as UTF-8, etc. It handles nesting, async and yield keywords, detects sets and tuple assignment, but only the grammar. It doesn’t know what those things are or what to do with them. It just cares about the text.
For example, the code that allows you to use the o notation for octal values is in the tokenizer. The code to actually create octal values is in the compiler.
Let’s add 2 things to <code>Parser/tokenizer.c</code>, the new INCREMENT and DECREMENT tokens, these are the keys that get returned by the tokenizer for each part of the code.</p>
<pre><code class="c">/* Token names */

const char *_PyParser_TokenNames[] = {
    &quot;ENDMARKER&quot;,
    &quot;NAME&quot;,
    &quot;NUMBER&quot;,
...
    &quot;INCREMENT&quot;,
    &quot;DECREMENT&quot;,
...
</code></pre>

<p>Then, we add check to return a <code>INCREMENT</code> or <code>DECREMENT</code> token, whenever we see ++ or — . There is already a function for 2 character operators, so we extend this to suit our case.</p>
<pre><code class="c">@@ -1175,11 +1177,13 @@ PyToken_TwoChars(int c1, int c2)
         break;
     case '+':
         switch (c2) {
+        case '+':               return INCREMENT;
         case '=':               return PLUSEQUAL;
         }
         break;
     case '-':
         switch (c2) {
+        case '-':               return DECREMENT;
         case '=':               return MINEQUAL;
         case '&gt;':               return RARROW;
         }
</code></pre>

<p>Those are defined in token.h</p>
<pre><code class="default">#define INCREMENT 58
#define DECREMENT 59
</code></pre>

<p>Now, when we run Python with -d and try our statement we see:</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/token-s.png"></p>
<p>It’s a token we know — Success!</p>
<h2 id="level-4-parser">Level 4 : Parser<a class="headerlink" href="#level-4-parser" title="Permanent link">&para;</a></h2>
<p>The parser takes those tokens and generates a structure that shows their relationship to each other. For Python and many other langauges, this is the Abstract Syntax Tree (or AST). The compiler then takes the AST and turns it into one (or more) code objects. Finally, the interpreter takes each code object executes the code it represents. Think of your code as a tree. The top level is the root, a function might be a branch, a class is a branch and the class methods branch off that. The statements are leaves within a branch.
The AST is defined in both ast.py and ast.c. ast.c is the file we need to change. The AST code is broken into methods that handle the types of tokens, ast_for_stmt handles statements, ast_for_expr handles expressions. We put the incr_stmtand decr_stmt as possible expression statements. They are almost identical to Augmented Expressions, e.g. test += 1 but there is no right-hand expression (1), it is implicit.
This is the code for us to add to handle increment and decrement.</p>
<pre><code class="c">static stmt_ty
ast_for_expr_stmt(struct compiling *c, const node *n)
{
    ...
    else if ((TYPE(CHILD(n, 1)) == incr_stmt) || (TYPE(CHILD(n, 1)) == decr_stmt)) {
        expr_ty expr1, expr2;
        node *ch = CHILD(n, 0);
        operator_ty operator;

        switch (TYPE(CHILD(n, 1))){
            case incr_stmt:
                operator = Add; 
                break;
            case decr_stmt:
                operator = Subtract; 
                break;
        }

        expr1 = ast_for_testlist(c, ch);
        if (!expr1) {
            return NULL;
        }
        switch (expr1-&gt;kind) {
            case Name_kind:
                if (forbidden_name(c, expr1-&gt;v.Name.id, n, 0)) {
                    return NULL;
                }
                expr1-&gt;v.Name.ctx = Store;
                break;
            default:
                ast_error(c, ch,
                          &quot;illegal target for increment/decrement&quot;);
                return NULL;
        }
        // Create a PyObject for the number 1
        PyObject *pynum = parsenumber(c, &quot;1&quot;);

        if (PyArena_AddPyObject(c-&gt;c_arena, pynum) &lt; 0) {
            Py_DECREF(pynum);
            return NULL;
        }
        // Create that as an expression on the same line and offset as the ++/--
        expr2 = Num(pynum, LINENO(n), n-&gt;n_col_offset, c-&gt;c_arena);
        return AugAssign(expr1, operator, expr2, LINENO(n), n-&gt;n_col_offset, c-&gt;c_arena);
</code></pre>

<p>This returns an Augmented Assignment — instead of a new Expression type with a constant value of 1. The operator is either Add or Sub(tract) depending on the token type incr_stmt or decr_stmt. Going back into the Python REPL after compiling — we can see our new statement!</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/token-s2.png"></p>
<p>At the REPL, you can try this : ast.parse(&ldquo;test=1; test++).body[1] and you’ll see the AugAssign type returned. The AST has just converted the statement into a statement expression which can then be handled by the compiler. The AugAssign function sets the field Kind which is used by the compiler.</p>
<h2 id="level-5-compiler">Level 5: Compiler<a class="headerlink" href="#level-5-compiler" title="Permanent link">&para;</a></h2>
<p>The compiler then takes the syntax tree and ‘visits’ each branch, the CPython compiler has a method for visiting a statement, called compile_visit_stmt which is just a big switch statement looking at the statement kind. Our’s was a AugAssign type, so it calls out to compiler_augassign to handle the details. This function then converts our statement into a set of Byte-codes. These are an intermediary language between machine code (01010101) and the syntax tree. The Byte-code sequence is the thing cached in .pyc files.</p>
<pre><code class="c">static int
compiler_augassign(struct compiler *c, stmt_ty s)
{
    expr_ty e = s-&gt;v.AugAssign.target;
    expr_ty auge;

    assert(s-&gt;kind == AugAssign_kind);

    switch (e-&gt;kind) {
...
    case Name_kind:
        if (!compiler_nameop(c, e-&gt;v.Name.id, Load))
            return 0;
        VISIT(c, expr, s-&gt;v.AugAssign.value);
        ADDOP(c, inplace_binop(c, s-&gt;v.AugAssign.op));
        return compiler_nameop(c, e-&gt;v.Name.id, Store);
</code></pre>

<p>The output would be VISIT (load value — which is 1 for us), ADDOP (add operation of a binary op, depending on the operator (subtract, add), and STORE_NAME (store the result of ADDOP to the Name). Those methods respond with more specific byte-codes.
If you load the dis module you can see the byte-code for yourself</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/opcodes.png"></p>
<h2 id="level-6-interpreter">Level 6: Interpreter<a class="headerlink" href="#level-6-interpreter" title="Permanent link">&para;</a></h2>
<p>The final level is the interpreter. That takes the byte-code sequence and converts it into machine-specific operations. This is why Python.exe and Python for mac and Linux are all seperate binaries. Some byte codes need OS specific handling and checks. The threading API for example needs to work with GNU/Linux’s thread API which is very different to Windows threading.
That’s it!</p>
<h2 id="further-reading">Further Reading<a class="headerlink" href="#further-reading" title="Permanent link">&para;</a></h2>
<p>If you’re interested in interpreters, I’ve given a talk on Pyjion, a plugin architecture for CPython which became PEP523</p>
<p>If you still want to play, I pushed the code up to GitHub, along with my changes to the await tokenizer.</p>
<p><a href="https://realpython.com/cpython-source-code-guide/">See also my article on realpython.com giving a full breakdown of the Python compiler</a></p>

        <div class="related-posts">
            <h2>Related Posts</h2>
            <div class="related-posts-grid">
                <a href="/posts/why-is-python-so-slow.html">
                <div class="related-box">
                    <img src="/img/posts/snail.jpg" alt="Why is Python so slow?" />
                    <div class="title">Why is Python so slow?</div>
                    <div class="subheading">A look into what makes Python slower than other languages</div>
                    <div class="post-meta"><i>Published July 16, 2018</i></div>
                </div>
                </a>
                <a href="/posts/learning-python.html">
                <div class="related-box">
                    <img src="/img/posts/learningpython.jpg" alt="Learning Python from Scratch" />
                    <div class="title">Learning Python from Scratch</div>
                    <div class="subheading">If you want to learn Python, where do you start?</div>
                    <div class="post-meta"><i>Published May 28, 2020</i></div>
                </div>
                </a>
                <a href="/posts/fine-tuning-wsgi-and-asgi-applications.html">
                <div class="related-box">
                    <img src="/img/posts/little-python-lemonade-stand.jpeg" alt="Fine Tuning Python WSGI and ASGI applications for Flask, Django, and FastAPI" />
                    <div class="title">Fine Tuning Python WSGI and ASGI applications for Flask, Django, and FastAPI</div>
                    <div class="subheading">Exploring strategies for optimal Gunicorn, Uvicorn and Hypercorn configurations for Flask, Django, and FastAPI</div>
                    <div class="post-meta"><i>Published December 20, 2023</i></div>
                </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-social">
            <a href="https://youtube.com/c/AnthonyShaw" aria-label="YouTube"><i class="fa fa-youtube"></i></a>
            <a href="https://github.com/tonybaloney" aria-label="GitHub"><i class="fa fa-github"></i></a>
            <a href="/rss.xml" aria-label="RSS Feed"><i class="fa fa-rss"></i></a>
        </div>
        <p class="footer-text">Copyright &copy; Anthony Shaw</p>
    </footer>

    <!-- jQuery -->
    <script src="/vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/vendor/bootstrap/js/bootstrap.min.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>

    <!-- Mobile menu toggle -->
    <script>
    (function() {
        var navToggle = document.querySelector('.navbar-toggle');
        var navLinks = document.querySelector('.navbar-links');
        if (navToggle && navLinks) {
            navToggle.addEventListener('click', function() {
                navLinks.classList.toggle('show');
            });
        }
    })();
    </script>

    <script>
    (function() {
        // Setup the toggle behavior and persistence. If the user hasn't chosen a preference, the site
        // follows the system preference (prefers-color-scheme). Stored choice overrides system changes.
        var toggle = document.getElementById('theme-toggle');
        var icon = toggle ? toggle.querySelector('i') : null;

        function getStored() {
            try { return localStorage.getItem('theme'); } catch (e) { return null; }
        }
        function setStored(t) {
            try { localStorage.setItem('theme', t); } catch (e) { }
        }
        function systemPrefersDark() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        }
        function updateIcon(t) {
            if (!icon) return;
            // sun when dark to indicate clicking will switch to light; moon when light to switch to dark
            icon.className = t === 'dark' ? 'fa fa-sun-o' : 'fa fa-moon-o';
        }
        function setTheme(t, save) {
            document.documentElement.setAttribute('data-theme', t);
            updateIcon(t);
            if (save) setStored(t);
        }

        if (toggle) {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                var current = document.documentElement.getAttribute('data-theme') || (systemPrefersDark() ? 'dark' : 'light');
                var next = current === 'dark' ? 'light' : 'dark';
                setTheme(next, true);
            });
            // initialize icon from the attribute (which was set early in the head)
            var initial = document.documentElement.getAttribute('data-theme') || (getStored() || (systemPrefersDark() ? 'dark' : 'light'));
            updateIcon(initial);
        }

        // If the user hasn't explicitly set a preference, follow system changes.
        try {
            var mq = window.matchMedia('(prefers-color-scheme: dark)');
            var onChange = function(e) {
                if (!getStored()) {
                    setTheme(e.matches ? 'dark' : 'light', false);
                }
            };
            if (mq.addEventListener) mq.addEventListener('change', onChange);
            else if (mq.addListener) mq.addListener(onChange);
        } catch (e) { }
    })();
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PNMEXCY7DV"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PNMEXCY7DV');
    </script>

    <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    var theme = document.documentElement.getAttribute('data-theme') || 'default';
    if (theme != 'dark'){
        theme = 'default';
    }
    mermaid.initialize({ 
        startOnLoad: true,
        theme: theme
     });
    </script>
</body>
</html>