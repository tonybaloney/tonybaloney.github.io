<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>XSS Exploitation in Django Applications</title>

    <!-- Facebook Meta tags -->
    <meta property="og:title" content="XSS Exploitation in Django Applications">
    <meta property="og:description" content="A deep-dive on XSS exploitations in Django applications, how to find them and how to fix them">
    <meta property="og:image" content="https://tonybaloney.github.io/img/posts/danger-snake.jpeg">
    <meta property="og:url" content="https://tonybaloney.github.io/posts/xss-exploitation-in-django.html">
    <!-- Twitter Meta Tags -->
    <meta name="twitter:title" content="XSS Exploitation in Django Applications">
    <meta name="twitter:description" content="A deep-dive on XSS exploitations in Django applications, how to find them and how to fix them">
    <meta name="twitter:image" content="https://tonybaloney.github.io/img/posts/danger-snake.jpeg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@anthonypjshaw">

    <!-- Bootstrap Core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Theme CSS -->
    <link href="/css/clean-blog.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>

    <script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/x86asm.min.js"></script>
    <script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/python.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    Menu <i class="fa fa-bars"></i>
                </button>

            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/#">Home</a>
                    </li>
                    <li>
                        <a href="/#projects">Projects</a>
                    </li>
                    <li>
                        <a href="/#contributions">Contributions</a>
                    </li>
                    <li>
                        <a href="/#courses">Courses</a>
                    </li>
                    <li>
                        <a href="/#podcasts">Podcasts</a>
                    </li>
                    <li>
                        <a href="/#talks">Talks</a>
                    </li>
                    <li>
                        <a href="/#blog">Blog</a>
                    </li>
                    <li>
                        <a href="https://twitter.com/anthonypjshaw"><i class='fa fa-2x fa-twitter'></i></a>
                    </li>
                    <li>
                        <a href="https://github.com/tonybaloney"><i class='fa fa-2x fa-github'></i></a>
                    </li>
                    <li>
                        <a href="https://www.youtube.com/c/AnthonyShaw"><i class='fa fa-2x fa-youtube-play'></i></a>
                    </li>
                    <li>
                        <a href="/rss.xml"><i class='fa fa-2x fa-rss-square'></i></a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="intro-header" style="background-image: url('/img/posts/danger-snake.jpeg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="site-heading">
                        <h1>XSS Exploitation in Django Applications</h1>
                        <hr class="small">
                        <span class="subheading">by Anthony Shaw, July 22, 2020</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <p>In this article, I&rsquo;m going to cover various exploits that can work against the Django templating engine in a modern web application.</p>
<p>I&rsquo;ll show how and why they work, as exploits, the risks of leaving them unfixed. Then, I&rsquo;ll show you how to find them using a fuzzer I&rsquo;ve been developing.</p>
<h2>A quick introduction to Cross-Site-Scripting</h2>
<p>Cross-Site-Scripting, or XSS, is the technique of exploiting web applications to cause trick users&rsquo; browsers to executing arbitrary (and malicious) JavaScript.</p>
<p>The malicious JavaScript code would be targeted to accomplish something like:</p>
<ul>
<li>Changing users passwords without their knowledge</li>
<li>Data gathering</li>
<li>Executing arbitrary actions</li>
</ul>
<p>This exploit works based on the assumption that the HTML and JavaScript served from a website&rsquo;s server is &ldquo;trusted&rdquo;.</p>
<p>If you visit your favourite website, you&rsquo;d expect that the HTML and JavaScript served to you and rendered in your browser is &ldquo;safe&rdquo;. Because of the mix between User-Generated-Content (UGC) and static content in
most modern applications,</p>
<p>Some common examples of content which is rendered as part of the site DOM from a database would be:</p>
<ul>
<li>A comments section at the bottom of the page</li>
<li>Names or profile pictures of users</li>
</ul>
<p>Instead of putting in their name as &ldquo;Jim Smith&rdquo;</p>
<pre><code class="html">Article posted by {{ user }}.
</code></pre>

<p>This is fine if <code>user = "Jim Smith"</code>, but if Jim is a bit more callous, then he could enter his name as <code>&lt;img src="https://media.giphy.com/media/I3eVhMpz8hns4/giphy.gif"/&gt;</code>.</p>
<p>Anyone viewing this page would then see the GIF that Jim injected into his username:</p>
<pre><code class="html">Article posted by &lt;img src=&quot;https://media.giphy.com/media/I3eVhMpz8hns4/giphy.gif&quot;/&gt;
</code></pre>

<p>This is an example of Stored/Permanent XSS. There are 2 groups of XSS exploits, which we&rsquo;ll explore:</p>
<ol>
<li>Reflected XSS</li>
<li>Stored/Permanent XSS</li>
</ol>
<h3>Reflected XSS</h3>
<p>Reflected XSS is common in both server-side and client-side applications. A common XSS flaw in applications that attackers will seek out
is a search page. Take this (very) simple example of a HTML + JavaScript page for showing a form asking for a search query
and showing what the user searched for if the GET parameters is existent.</p>
<pre><code class="html">&lt;html lang=&quot;en-AU&quot;&gt;
&lt;body&gt;
&lt;form method=&quot;get&quot;&gt;
    &lt;label for=&quot;query&quot;&gt;Search: &lt;/label&gt;
    &lt;input type=&quot;text&quot; id=&quot;query&quot; name=&quot;query&quot; /&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Search&quot; /&gt;
&lt;/form&gt;

&lt;span id=&quot;search-query&quot; &gt;&lt;/span&gt;

&lt;!-- The results of the search query --&gt;

&lt;script type=&quot;application/javascript&quot;&gt;
    var searchParams = new URLSearchParams(document.location.search);
    if (searchParams.has(&quot;query&quot;))
    {
        document.getElementById(&quot;search-query&quot;).innerHTML = &quot;You searched for &quot; + searchParams.get(&quot;query&quot;)
    }
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Your regular user would search a text string which is shown on the page:</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/simple-search.png" style="width:40%"></p>
<p>An attacker could search for any valid HTML and it would become part of the DOM:</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/guacamole-dance.gif"></p>
<p>In the reflective XSS model, the malicious payload is sent back to the attacker. This type of attack is less-dangerous than permanent XSS.</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/reflective-xss.png"></p>
<p>Reflective XSS attacks are used by attackers sending a link and tricking a user to show the reflected payload to accomplish the hack.</p>
<h3>Stored/Permanent XSS</h3>
<p>Permanent XSS attacks are far more dangerous to an application because the attack has the opporunity to impact all of the users of the site, including the site administrators.</p>
<p>The attack mechanism is the same as reflective, but the server-side application stores the malicious payload in a database, or a file of some sort:</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/permanent-xss.png"></p>
<p>Some really-basic examples I shared were user names, comments, and profile photos.</p>
<p>Permanent XSS attacks are often used for</p>
<ul>
<li>Sending a &ldquo;beacon&rdquo; to the attacker with some details about the target, such as their IP address, user name, browser, OS, password, etc.</li>
<li>Making POST requests to parts of the application which let the attacker take over an account by changing the password.</li>
<li>Combining with <a href="https://www.youtube.com/watch?v=IVHX9jDrI0o">SQL Injection</a> vulnerabilities to exfiltrate data from the database.</li>
</ul>
<h2>Django fights back</h2>
<p>Django assumes that all context data is &ldquo;unsafe&rdquo; unless otherwise specified.</p>
<p>This means that <strong>most</strong> forms of XSS attack don&rsquo;t work with Django templates.</p>
<p>For example, if you wrote the following template:</p>
<pre><code class="html">&lt;html lang=&quot;en-AU&quot;&gt;
&lt;body&gt;
&lt;form method=&quot;get&quot;&gt;
    &lt;label for=&quot;query&quot;&gt;Search: &lt;/label&gt;
    &lt;input type=&quot;text&quot; id=&quot;query&quot; name=&quot;query&quot; /&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Search&quot; /&gt;
&lt;/form&gt;

&lt;span id=&quot;search-query&quot; &gt;You searched for {{ query }}&lt;/span&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Django would automatically escape the malicious string in the <code>query</code> context variable:</p>
<pre><code>&lt;img src=&quot;https://media.giphy.com/media/I3eVhMpz8hns4/giphy.gif&quot;/&gt;
</code></pre>

<p>To:</p>
<pre><code>&amp;lt;img src=&amp;quot;https://media.giphy.com/media/I3eVhMpz8hns4/giphy.gif&amp;quot;/&amp;gt;
</code></pre>

<p>It does this by passing all string data through Python&rsquo;s <code>html.escape()</code> function.
This function will:</p>
<ol>
<li>Replace any <code>&amp;</code> with an <code>&amp;amp;</code> ampersand HTML character-reference</li>
<li>Replace any <code>&lt;</code> or <code>&gt;</code> with an <code>&amp;lt;</code> or <code>&amp;gt;</code> HTML character-reference</li>
<li>Replace any <code>"</code> with an escaped <code>\"</code></li>
<li>Replace any <code>'</code> with an escaped <code>\'</code></li>
</ol>
<p>To say that this escaping of these 5 characters &ldquo;protects&rdquo; your application is a gross-underestimation of XSS.</p>
<h2>Caveats to Django XSS protection</h2>
<p>There are many caveats to Django XSS protection, and as you learn more about XSS you&rsquo;ll be able to spot them in your templates.</p>
<h3>1. It only applies to the Django template engine</h3>
<p>The XSS protection for Django is part of the Django templating engine. If your application heavily uses a client-side JavaScript frame (such as Angular, Vue, React)
then the Django XSS protection is not helping you.</p>
<p>An example of a reflective XSS vulnerability is a third-party JavaScript component on your page. Many third-party JavaScript components, such as type-ahead widgets have XSS flaws.</p>
<p>Furthermore, many Django extensions that rely on combined JavaScript/Python logic have XSS flaws. These include many form extensions like Date/Time selectors. Some of these flaws have been discovered and fixed,
but many go unnoticed.</p>
<p><strong>What can you do about this?</strong></p>
<ul>
<li>Check your JavaScript and Python dependencies against a CVE database like Snyk.io</li>
<li>Test the whole application (see later in this article) with malicous payloads</li>
</ul>
<h3>2. It does not protect against the misuse of &ldquo;Safe Strings&rdquo;</h3>
<p>The Django XSS protection can be disabled when a string is marked as &ldquo;safe&rdquo;, either in the View logic by using the <code>mark_safe()</code> function, or in the template using the <code>safe</code> filter.</p>
<pre><code class="python">format_html(&quot;{} &lt;b&gt;{}&lt;/b&gt; {}&quot;,
    mark_safe(some_html),
    some_text,
    some_other_text,
)
</code></pre>

<p>Alternatively, in the template you can use the <code>safe</code> filter to disable the HTML escape protection:</p>
<pre><code class="html">&lt;span id=&quot;search-query&quot; &gt;You searched for {{ query | safe }}&lt;/span&gt;
</code></pre>

<p>This may seem obvious that by explicitly disabling XSS protection that it doesn&rsquo;t protect you against XSS, but <em>&ldquo;Use <code>mark_safe()</code>&ldquo;</em> is an accepted solution to a worrying number of Django questions
on StackOverflow.com.</p>
<p><strong>What can you do about this?</strong></p>
<ul>
<li>Search your code base for use of the <code>safe</code> filter</li>
<li>Search your code base for the use of <code>mark_safe</code> function by using [my PyCharm extension]</li>
<li>Use bleach to clean out any potentially vulnerable attributes</li>
</ul>
<p>Here is an example of a filter tag that I wrote to convert using Bleach to remove any potentially harmful data:</p>
<pre><code class="python">from django import template
from django.utils.safestring import mark_safe
import bleach

register = template.Library()
_ALLOWED_ATTRIBUTES = {
        'a': ['href', 'title'],
        'img': ['src', 'class'],
        'table': ['class']
}
_ALLOWED_TAGS = ['b', 'i', 'ul', 'li', 'p', 'br', 'a', 'h1', 'h2', 'h3', 'h4', 'ol', 'img', 'strong', 'code', 'em', 'blockquote',
    'table', 'thead', 'tr', 'td', 'tbody', 'th']

@register.filter()
def safer(text):
    return mark_safe(bleach.clean(text, tags=_ALLOWED_TAGS, attributes=_ALLOWED_ATTRIBUTES))
</code></pre>

<p>You&rsquo;d use this tag as a drop-in replacement for <code>safe</code>:</p>
<pre><code class="html">&lt;span id=&quot;search-query&quot; &gt;You searched for {{ query | safer }}&lt;/span&gt;
</code></pre>

<h3>3. Some types of attribute escape are not protected</h3>
<p>Many XSS techniques use HTML/JavaScript event handlers as attributes of existing tags instead of new <code>&lt;script&gt;</code> tags.</p>
<p>For example, many HTML elements support an <code>onload</code> event. The HTML can have any JavaScript action as a trigger and it doesn&rsquo;t require any user interaction:</p>
<pre><code class="html">&lt;img src=/img/home-bg.jpg onload=alert(1)&gt;
</code></pre>

<p>If your Django template had the <code>src</code> attribute replaced with a context variable:</p>
<pre><code class="html">&lt;img src={{ profile_photo }}&gt;
</code></pre>

<p>The attacker would set their profile photo URL to <code>"/img/home-bg.jpg onload=alert(1)"</code> to accomplish this attack.
Because you didn&rsquo;t encapsulate the <code>src</code> attribute in quotes, the Django XSS protection won&rsquo;t escape the input.</p>
<p><strong>What can you do about this?</strong></p>
<ul>
<li>Always quote your attributes if they come from user-generated/untrusted sources</li>
</ul>
<h3>4. It does not protect against other attributes which accept JavaScript</h3>
<p>Let&rsquo;s say you let your users add a link to their personal website that shows up on their profile page inside your application.</p>
<pre><code class="html">&lt;a href=&quot;{{ user.profile_url }}&quot;&gt;Website&lt;/a&gt;
</code></pre>

<p>What could go wrong?</p>
<p>Well, the attacker can just put <code>"javascript:do_stuff(xxvb)"</code> as the link to their website, so if the user clicks on the link, it executes whatever JavaScript the attacker wishes.</p>
<p>You could check for <code>user.profile_url.startswith("javascript:")</code>, however the following are also valid in most browsers:</p>
<ul>
<li><code>&lt;a href="JaVaScript:alert(1)"&gt;XSS&lt;/a&gt;</code> (the protocol is case insensitive)</li>
<li><code>&lt;a href="    javascript:alert(1)"&gt;XSS&lt;/a&gt;</code> (the characters \x01-\x20 are allowed before the protocol)</li>
<li><code>&lt;a href="javas   cript:alert(1)"&gt;XSS&lt;/a&gt;</code> (the characters \x09,\x0a,\x0d are allowed inside the protocol)</li>
<li><code>&lt;a href="javascript \x09:alert(1)"&gt;XSS&lt;/a&gt;</code> (the characters \x09,\x0a,\x0d are allowed after protocol name before the colon)</li>
</ul>
<p><strong>What can you do about this?</strong></p>
<ul>
<li>Sanitize links before they&rsquo;re stored in the database, or</li>
<li>Don&rsquo;t offer this behaviour on the application.</li>
</ul>
<h3>5. <code>html.escape()</code> does not escape JavaScript template strings</h3>
<p>The escape function that Django XSS protection uses will escape the string quotes <code>'</code> and <code>"</code>.</p>
<p><code>html.escape()</code> <strong>does not</strong> escape the backtick ``` used in ECMAScript Template literals. Template literals are part of the ES2015 specification (supported in any browser except IE).</p>
<p>This is valid ES6:</p>
<pre><code class="javascript">let name = `Ryan`;
console.log(`Hi my name is ${name}`);  // Hi my name is Ryan
</code></pre>

<h3>6. It does not protect against the data protocol base64 encoded strings</h3>
<pre><code class="html">&lt;iframe src=&quot;{{ company_website }}&quot;&gt;&lt;/script&gt;
</code></pre>

<p>You can encode any HTML string to get around the <code>escape()</code> filter used base 64. If you mark the URL using the data protocol and base64 encoding, the browser will decode the string and load the HTML.</p>
<p><code>&lt;script&gt;alert('hi');&lt;/script&gt;</code> in base 64 is <code>PHNjcmlwdD5hbGVydCgnaGknKTs8L3NjcmlwdD4=</code> to the data protocol string is:</p>
<pre><code>data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGknKTs8L3NjcmlwdD4=
</code></pre>

<p>This doesn&rsquo;t contain any of the &ldquo;unsafe&rdquo; entities that <code>html.escape()</code> looks for.</p>
<h3>7. It does not protect against unquoted JavaScript injections</h3>
<p>Let&rsquo;s say that you have a Spinner widget that lets the user select their price range for buying a car.</p>
<p>They can enter their price range as $5000 - $10000 dollars and you set the minimum and maximum values for this widget inside your template.<br>
Because they are JavaScript integers, you don&rsquo;t use quotes:</p>
<pre><code class="html">&lt;script type=text/javascript src=&quot;ext/spinner.js&quot;&gt;&lt;/script&gt;
&lt;script type=text/javascript&gt;
    var spinner = new SpinnerWidget();
    spinner.minimum = {{ minimum_price }} ;
    spinner.maximum = {{ maximum_price }} ;
    spinner.show();
&lt;/script&gt;
</code></pre>

<p>In this example, <code>minimum_price</code> can be <code>0 ; malicious_code()</code> and it will inject the JS directly into the rendered page.
Again, the XSS protection in Django will not protect you here, because it doesn&rsquo;t contain any quotes or HTML entities.</p>
<p><strong>What can you do about this?</strong></p>
<ul>
<li>Move this logic into an API, or</li>
<li>Validate the input</li>
</ul>
<h2>XSS Fuzzing to detect permanent and reflective vulnerabilities</h2>
<p>Because there are so many potential caveats to Django XSS protection, I decided to write a testing utility for detecting possible vulnerabilities in templates.</p>
<p>The way it works is as a piece of Django Middleware that you use whilst testing which replaces any string-like value in the context data with a malicous string.</p>
<p>So far, I&rsquo;ve added the following test strings. Each one will try and call <code>console.log('--SUCCESS[field]--')</code> to write to the JavaScript console log to prove the flaw.</p>
<pre><code class="python">DEFAULT_PATTERNS = (
    XssPattern('&lt;script&gt;throw onerror=eval,\'=console.log\x28\\\'{0}\\\'\x29\'&lt;/script&gt;', &quot;Script tag with onerror event&quot;),
    XssPattern('x onafterscriptexecute=&quot;console.log(\'{0}\')&quot;',  &quot;non-quoted attribute escape&quot;),
    XssPattern('x onafterscriptexecute=&quot;console.log(`{0}`)&quot;',  &quot;non-quoted attribute escape with backticks&quot;),
    XssPattern('&lt;script&gt;console.log(`{0}`)&lt;/script&gt;',  &quot;template strings&quot;),
    XssPattern('x onafterprint=&quot;console.log(\'{0}\')&quot;',  &quot;non-quoted attribute escape on load&quot;),
    XssPattern('x onerror=&quot;console.log(\'{0}\')&quot;',  &quot;non-quoted attribute escape on load&quot;),
    XssPattern('x onafterprint=&quot;console.log(`{0}`)&quot;',  &quot;non-quoted attribute escape on load with backticks&quot;),
    XssPattern('+ADw-script+AD4-console.log(+ACc-{0}+ACc-)+ADw-/script+AD4-',  &quot;UTF-7 charset meta&quot;),
    XssPattern('data:text/javascript;base64,Y29uc29sZS5sb2coJy0tU1VDQ0VTU1tdLS0nKQ==',  &quot;JS-encoded base64, payload is '--SUCCESS[]--'&quot;)
)
</code></pre>

<p>The middleware is very aggressive, so don&rsquo;t deploy this anywhere other than a testing environment!</p>
<p>To install via pip</p>
<pre><code class="console">$ pip install django-xss-fuzzer
</code></pre>

<p>Add <code>ViewFuzzerMiddleware</code> to your middleware list for a <strong>test environment</strong>.</p>
<pre><code class="python">MIDDLEWARE = [
    ...
    'django_xss_fuzzer.ViewFuzzerMiddleware'
]
</code></pre>

<p>Once you&rsquo;ve restarted Django, it will replace anything &ldquo;string-like&rdquo; in the context data with a malicious string.
By default it will try <code>&lt;script&gt;throw onerror=eval,\'=console.log\x28\\\'{0}\\\'\x29\'&lt;/script&gt;</code>.</p>
<p>The values that will be replaced :
- Any string variables
- Any attributes in a model instance that are strings
- Any attributes in a QuerySet containing data models that are strings</p>
<p><img alt="fuzzer" class="img-responsive center-block" src="/img/posts/fuzzer.png"></p>
<p>When you browse any of the pages on your site, you should see Django successfully protecting and escaping the strings.</p>
<p><img alt="evil-page" class="img-responsive center-block" src="/img/posts/evil-page.png" style="width:40%"></p>
<p>When you open the JavaScript console, if you see any <code>--SUCCESS[]--</code> messages this means your page is vulnerable, the name of the field that it replaced will be inside square brackets.</p>
<p>To change the malicious string, set the <code>XSS_PATTERN</code> variable in your Django settings.</p>
<p>It&rsquo;s designed to be paired with PyTest, PyTest-Django, and Selenium so that it will try a range of malicious strings until it finds a successful attack vector.</p>
<p>The selenium integration is required so that each view will be rendered and then processed by Chrome. Once Chrome has loaded the page, the tool will inspect the JavaScript log for any occurences of <code>--SUCCESS[field]--</code>
and then fail the test if one is found.</p>
<p>Here is an example test for the URLs <code>/</code> and <code>/home</code>:</p>
<pre><code class="python">import pytest


paths = (
    '/',
    '/home'
)


@pytest.mark.django_db()
@pytest.mark.parametrize('path', paths)
def test_xss_patterns(selenium, live_server, settings, xss_pattern, path):
    setattr(settings, 'XSS_PATTERN', xss_pattern.string)
    selenium.get('%s%s' % (live_server.url, path))
    assert not xss_pattern.succeeded(selenium), xss_pattern.message
</code></pre>

<p>The test function <code>test_xss_patterns</code> is a parametrized test that will run a live server using <code>pytest-django</code> and open a browser for each test using <code>pytest-selenium</code>.
To test more views, just add the URIs to <code>paths</code>.</p>
<p>To setup selenium, add the following to your <code>conftest.py</code>:</p>
<pre><code class="python">import pytest


@pytest.fixture(scope='session')
def session_capabilities(session_capabilities):
    session_capabilities['goog:loggingPrefs'] = {'browser': 'ALL'}

    return session_capabilities


@pytest.fixture
def chrome_options(chrome_options):
    chrome_options.headless = True
    return chrome_options
</code></pre>

<p>This will configure Chrome as headless and enable logging to capture the XSS flaws.</p>
<p>To run PyTest with this plugin, use the <code>--driver</code> flag as Chrome and <code>--driver-path</code> to point to a downloaded version of the Chrome Driver for the version of Chrome you have installed.</p>
<pre><code class="console"> $ python -m pytest tests/ --driver Chrome --driver-path ~/Downloads/chromedriver83 -rs -vv
</code></pre>

<p>Once this is running, you&rsquo;ll see something similar to the following output:</p>
<p><img alt="" class="img-responsive center-block" src="/img/posts/django-xss-fuzzer.gif"></p>
<p>For each failed test, inspect that particular view with the attack string and see where the potential vulnerability is.</p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 col-md-offset-8">
                <a class="btn-default btn"
                   href="https://twitter.com/intent/tweet">
                    <i class="fa fa-twitter"></i>
                    Share on Twitter</a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://twitter.com/anthonypjshaw">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://youtube.com/c/AnthonyShaw">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/tonybaloney">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Copyright &copy; Anthony Shaw</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Theme JavaScript -->
    <script src="/js/clean-blog.min.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>

    <!-- Twitter Helper -->
    <script>window.twttr = (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0],
            t = window.twttr || {};
        if (d.getElementById(id)) return t;
        js = d.createElement(s);
        js.id = id;
        js.src = "https://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js, fjs);

        t._e = [];
        t.ready = function(f) {
            t._e.push(f);
        };
        return t;
    }(document, "script", "twitter-wjs"));</script>

    <script type="text/javascript">
        !function(T,l,y){var S=T.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
        src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source
        // name: "appInsights", // Global SDK Instance name defaults to "appInsights" when not supplied
        // ld: 0, // Defines the load delay (in ms) before attempting to load the sdk. -1 = block page load and add to head. (default) = 0ms load after timeout,
        // useXhr: 1, // Use XHR instead of fetch to report failures (if available),
        crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag
        // onInit: null, // Once the application insights instance has loaded and initialized this callback function will be called with 1 argument -- the sdk instance (DO NOT ADD anything to the sdk.queue -- As they won't get called)
        cfg: { // Application Insights Configuration
            instrumentationKey: "d0222e7b-7c27-4322-8d0f-36fa2df51f86"
        }});
    </script>
</body>
</html>